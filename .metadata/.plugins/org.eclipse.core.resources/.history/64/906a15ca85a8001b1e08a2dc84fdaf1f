package br.com.stackx.projetoweb.controller;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;

import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.servlet.ModelAndView;

import br.com.stackx.projetoweb.dao.DAO;
import br.com.stackx.projetoweb.dao.EstadoDAO;
import br.com.stackx.projetoweb.exception.StackxException;
import br.com.stackx.projetoweb.model.Estado;

@Controller // informa aospring que é uma classe de controller
public class EstadoController {

	@RequestMapping(value = "/CadastroEstado", method = RequestMethod.GET) // como sera chamado pelo navegador, eo //
																			// método
	public ModelAndView cadastroEstado(@ModelAttribute("SpringWeb") Estado estado, ModelMap model)
			throws StackxException {

		System.out.println(estado.getIdEstado());
		if (estado.getIdEstado() != 0) {
			System.out.println("recuperando o Estado");

			DAO.init();

			EstadoDAO estadoDAO = new EstadoDAO();
			estadoDAO.setIdEstado(estado.getIdEstado());
			estadoDAO.select();

			estado = estadoDAO;
		}

		return new ModelAndView("cadastroEstado", "command", estado);// nome do JSP, command, classe model
	}

	@RequestMapping(value = "/addEstado", method = RequestMethod.POST)
	public String addEstado(@Valid @ModelAttribute("command") Estado estado, BindingResult result, ModelMap model,
			HttpServletRequest request) {

		try {

			if (result.hasErrors() || result.hasFieldErrors()) {
				System.out.println("## Tem erro de validação ##");

				return "cadastroEstado";
				// return cadastroEstado(estado, model);
			}

			System.out.println("idEstado: " + estado.getIdEstado());
			System.out.println("Nome: " + estado.getNome());
			System.out.println("Sigla: " + estado.getSigla());
			System.out.println("Código Ibge: " + estado.getCodigoIbge());

			model.addAttribute("idEstado", estado.getIdEstado());
			model.addAttribute("nome", estado.getNome());
			model.addAttribute("sigla", estado.getSigla());
			model.addAttribute("codigoIbge", estado.getCodigoIbge());

			// Inserir no BD
			DAO.init();

			EstadoDAO estadoDAO = new EstadoDAO();
			estadoDAO.setNome(estado.getNome());
			estadoDAO.setSigla(estado.getSigla());
			estadoDAO.setCodigoIbge(estado.getCodigoIbge());

			if (estado.getIdEstado() == 0) {
				System.out.println("Fazendo o insert");
				estadoDAO.insert();
			} else {
				System.out.println("Fazendo o update");
				estadoDAO.setIdEstado(estado.getIdEstado());
				estadoDAO.update();
			}

			//return "redirect:ListaEstado";// invoca a página no navegador
			// return new ModelAndView("exibeEstado", "command", estado) => nome do JSP,
			// command, classe model estado
			 return "listaEstado;" retorna uma página JSP cujo o nome é exibeEstado

		} catch (Exception exception) {
			exception.printStackTrace();
			return null;
		}

	}

	// Lista
	@RequestMapping(value = "/ListaEstado", method = RequestMethod.GET)
	public ModelAndView listaEstado(@ModelAttribute("SpringWeb") Estado estado, ModelMap model,
			HttpServletRequest request) {

		try {
			DAO.init();
			EstadoDAO estadoDAO = new EstadoDAO();
			// chamar o método selectAll
			List<Estado> listEstados = estadoDAO.sellectAll();

			// adicionar ele no model.addAtribute("idEstado, estado.getIdEstado())")
			model.addAttribute("estados", listEstados);

			return new ModelAndView("listaEstado", "command", estado);
			// return "listaEstado";

		} catch (StackxException stackxException) {
			stackxException.getException().printStackTrace();
			return null;
		}

	}

	private ModelAndView ModelAndView(String string) {
		// TODO Auto-generated method stub
		return null;
	}

}
